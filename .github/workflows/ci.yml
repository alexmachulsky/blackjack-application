name: CI

on:
    push:
        branches: [main, develop, "feature/**", "fix/**"]
    pull_request:
        branches: [main, develop]

# Principle of least privilege — every token starts read-only.
# Jobs that need more declare their own permissions block below.
permissions:
    contents: read

# Cancel in-progress runs for the same branch/PR to save CI minutes.
# cancel-in-progress: false on main to avoid interrupting a release build.
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
    # ──────────────────────────────────────────────────────────────
    # Job 1a: Backend lint — ruff + black
    # Runs in parallel with lint-frontend for faster feedback.
    # ──────────────────────────────────────────────────────────────
    lint-backend:
        name: Lint — Backend
        runs-on: ubuntu-22.04   # pin runner; ubuntu-latest is non-deterministic
        timeout-minutes: 10

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: pip

            - name: Upgrade pip
              run: pip install --upgrade pip

            - name: Install lint deps
              run: pip install "ruff==0.2.1" "black==24.1.1"

            - name: Ruff lint
              run: ruff check .
              working-directory: backend

            - name: Black format check
              run: black --check .
              working-directory: backend

    # ──────────────────────────────────────────────────────────────
    # Job 1b: Frontend lint — build check (no ESLint yet; add when ready)
    # Runs in parallel with lint-backend.
    # ──────────────────────────────────────────────────────────────
    lint-frontend:
        name: Lint — Frontend
        runs-on: ubuntu-22.04
        timeout-minutes: 10

        steps:
            - uses: actions/checkout@v4

            - name: Set up Node 20
              uses: actions/setup-node@v4
              with:
                  node-version: "20"   # Node 18 is EOL since Apr 2025
                  cache: npm
                  cache-dependency-path: frontend/package-lock.json

            - name: Install deps
              run: npm ci
              working-directory: frontend

            - name: Frontend build check
              run: npm run build
              working-directory: frontend

    # ──────────────────────────────────────────────────────────────
    # Job 2: SAST — Bandit static security analysis
    # Runs after backend lint passes.
    # Fails on MEDIUM or HIGH severity findings.
    # ──────────────────────────────────────────────────────────────
    security-scan:
        name: Security Scan (SAST)
        runs-on: ubuntu-22.04
        timeout-minutes: 10
        needs: lint-backend

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: pip

            - name: Upgrade pip
              run: pip install --upgrade pip

            - name: Install Bandit
              run: pip install "bandit[toml]==1.7.7"

            # Text report → readable in CI log; exits non-zero if issues found → fails job
            - name: Run Bandit SAST
              run: bandit -r app/ -ll -x tests/
              working-directory: backend

            # JSON report for artifact archive — --exit-zero so this step never blocks
            - name: Save Bandit JSON report
              if: always()
              run: bandit -r app/ -ll -x tests/ --exit-zero --format json --output bandit-report.json
              working-directory: backend

            - name: Upload Bandit report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: bandit-report
                  path: backend/bandit-report.json
                  retention-days: 30

    # ──────────────────────────────────────────────────────────────
    # Job 3: Backend unit tests — SQLite in-process (no Docker needed)
    # Runs after backend lint passes, in parallel with security-scan.
    # ──────────────────────────────────────────────────────────────
    test-backend:
        name: Backend Tests
        runs-on: ubuntu-22.04
        timeout-minutes: 15
        needs: lint-backend

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: pip

            - name: Upgrade pip
              run: pip install --upgrade pip

            - name: Install production + dev deps
              # psycopg2-binary is installed but never imported:
              # DATABASE_URL=sqlite:// makes SQLAlchemy use its SQLite dialect,
              # so the psycopg2 module is never loaded during tests.
              run: pip install -r requirements.txt -r requirements-dev.txt
              working-directory: backend

            - name: Run pytest with coverage
              env:
                  DATABASE_URL: sqlite:///./test.db
                  SECRET_KEY: ci-test-secret-key-minimum-32-characters-long
                  ENVIRONMENT: testing
                  PYTHONDONTWRITEBYTECODE: "1"
                  PYTHONUNBUFFERED: "1"
              run: |
                  pytest tests/ \
                    --cov=app \
                    --cov-report=xml:coverage.xml \
                    --cov-report=term-missing \
                    -v
              working-directory: backend

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: backend-coverage
                  path: backend/coverage.xml
                  retention-days: 30

    # ──────────────────────────────────────────────────────────────
    # Job 4: Docker build + Trivy CVE scan
    # Runs only after ALL prior jobs pass (security, tests, and frontend lint).
    # Images are built but NOT pushed here — push happens in cd.yml.
    #
    # Requires security-events: write to upload SARIF to GitHub Security tab.
    # ──────────────────────────────────────────────────────────────
    docker-build:
        name: Docker Build & Scan
        runs-on: ubuntu-22.04
        timeout-minutes: 20
        needs: [security-scan, test-backend, lint-frontend]

        permissions:
            contents: read
            security-events: write   # required for github/codeql-action/upload-sarif

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            # ── Backend ───────────────────────────────────────────
            - name: Build backend image
              uses: docker/build-push-action@v5
              with:
                  context: ./backend
                  push: false
                  load: true   # exposes image to local daemon so Trivy can scan it
                  tags: blackjack-backend:ci
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            # Blocking scan — fails job on CRITICAL CVEs so the build never promotes
            - name: Trivy scan — backend (blocking)
              uses: aquasecurity/trivy-action@0.24.0
              with:
                  image-ref: blackjack-backend:ci
                  format: table
                  exit-code: "1"
                  severity: CRITICAL
                  ignore-unfixed: true

            # Non-blocking SARIF scan — runs even if the table scan above failed
            - name: Trivy scan — backend (SARIF)
              uses: aquasecurity/trivy-action@0.24.0
              if: always()
              with:
                  image-ref: blackjack-backend:ci
                  format: sarif
                  output: trivy-backend.sarif
                  ignore-unfixed: true

            - name: Upload backend SARIF to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: trivy-backend.sarif
                  category: trivy-backend

            # ── Frontend ──────────────────────────────────────────
            - name: Build frontend image
              uses: docker/build-push-action@v5
              with:
                  context: ./frontend
                  target: production
                  push: false
                  load: true
                  tags: blackjack-frontend:ci
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Trivy scan — frontend (blocking)
              uses: aquasecurity/trivy-action@0.24.0
              with:
                  image-ref: blackjack-frontend:ci
                  format: table
                  exit-code: "1"
                  severity: CRITICAL
                  ignore-unfixed: true

            - name: Trivy scan — frontend (SARIF)
              uses: aquasecurity/trivy-action@0.24.0
              if: always()
              with:
                  image-ref: blackjack-frontend:ci
                  format: sarif
                  output: trivy-frontend.sarif
                  ignore-unfixed: true

            - name: Upload frontend SARIF to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: trivy-frontend.sarif
                  category: trivy-frontend
