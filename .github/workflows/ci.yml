name: CI

on:
  push:
    branches:
      - main
      - "feature/**"
  pull_request:
    branches:
      - main

# Default: all jobs get read-only access.
# The Push-to-ECR job overrides this with contents: write for git tag creation.
permissions:
  contents: read

# Cancel in-flight runs on the same branch on every new push.
# Never cancel a run that is already deploying main.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

# ─────────────────────────────────────────────────────────────────────────────
#  JOB 1 — Build & Test
#  • Install Python dependencies
#  • Lint (ruff + black)
#  • Run full pytest suite (unit + integration) against SQLite
#  • Start the backend with uvicorn and verify /health responds
# ─────────────────────────────────────────────────────────────────────────────
jobs:
  dependency-review:
    name: Dependency Review (PR)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Review dependency changes
        uses: actions/dependency-review-action@v4

  Build-application:
    name: Build & Test (${{ github.ref_name }})
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements*.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
        working-directory: backend

      - name: Lint — ruff
        run: ruff check .
        working-directory: backend

      - name: Lint — black (format check)
        run: black --check .
        working-directory: backend

      - name: Run unit + integration tests
        env:
          DATABASE_URL: sqlite:///./test.db
          SECRET_KEY: ci-build-secret-key-minimum-32-characters-long
          ENVIRONMENT: testing
        run: pytest tests/ -v --tb=short
        working-directory: backend

      - name: Dependency vulnerability audit (Python)
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt --strict
        working-directory: backend

      - name: Filesystem vulnerability scan (Trivy)
        uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8cce1229c54b2c9bd0d8 # v0.24.0
        with:
          scan-type: fs
          scan-ref: .
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          format: table

      - name: Start backend (health check)
        env:
          DATABASE_URL: sqlite:///./smoke.db
          SECRET_KEY: ci-build-secret-key-minimum-32-characters-long
          ENVIRONMENT: testing
        run: |
          nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > uvicorn.log 2>&1 &
          echo "Waiting for backend to start..."
          for i in {1..30}; do
            if curl -sf http://localhost:8000/ready > /dev/null; then
              echo "✅ Backend is up! (attempt $i)"
              break
            fi
            echo "⏳ Still waiting... ($i)"
            sleep 1
          done
          curl --fail http://localhost:8000/ready || \
            { echo "❌ Backend did not respond!"; cat uvicorn.log; exit 1; }
        working-directory: backend

  # ───────────────────────────────────────────────────────────────────────────
  #  JOB 2 — Package
  #  • Build backend and frontend Docker images using Buildx
  #  • GHA layer cache keeps repeat builds fast
  # ───────────────────────────────────────────────────────────────────────────
  Package-application:
    name: Package (${{ github.ref_name }})
    needs: [dependency-review, Build-application]
    if: always() && needs.Build-application.result == 'success' && (github.event_name != 'pull_request' || needs.dependency-review.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: false
          tags: blackjack-backend:latest
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: Build frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: false
          tags: blackjack-frontend:latest
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      - name: Cleanup Docker
        run: |
          docker system prune -af
          docker builder prune -af

  # ───────────────────────────────────────────────────────────────────────────
  #  JOB 3 — E2E Smoke Tests
  #  • Spin up postgres + backend via docker compose
  #  • Run curl smoke tests against the live HTTP API
  #  • Tear down always runs (even on failure)
  # ───────────────────────────────────────────────────────────────────────────
  E2E-tests:
    name: E2E Smoke Tests (${{ github.ref_name }})
    needs: Push-to-ECR
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Write ephemeral CI credentials — never used outside this job
      - name: Create .env for stack
        run: |
          cat > .env <<'EOF'
          POSTGRES_USER=blackjack
          POSTGRES_PASSWORD=blackjack_ci_pw
          POSTGRES_DB=blackjack
          DATABASE_URL=postgresql://blackjack:blackjack_ci_pw@postgres:5432/blackjack
          SECRET_KEY=ci-e2e-secret-key-32-characters-minimum
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          ENVIRONMENT=testing
          LOG_LEVEL=WARNING
          EOF
          # Strip leading whitespace from each line (YAML indentation artefact)
          sed -i 's/^[[:space:]]*//' .env

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Login to Amazon ECR (private)
        run: |
          aws ecr get-login-password --region ap-south-1 | \
            docker login --username AWS --password-stdin \
            904233124111.dkr.ecr.ap-south-1.amazonaws.com

      - name: Pull backend image from ECR
        run: |
          docker pull 904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application:backend-${{ needs.Push-to-ECR.outputs.tag }}
          echo "✅ Pulled backend-${{ needs.Push-to-ECR.outputs.tag }} from ECR"

      - name: Start stack using ECR image (postgres + backend)
        run: |
          IMAGE_TAG=${{ needs.Push-to-ECR.outputs.tag }} \
            docker compose -f docker-compose.yml -f docker-compose.ecr.yml \
            up --no-build -d postgres backend

      - name: Wait for backend health
        run: |
          echo "Waiting for backend to start and connect to Postgres..."
          for i in {1..30}; do
            if curl -sf http://localhost:8001/ready > /dev/null; then
              echo "✅ Backend is up AND connected to Postgres! (attempt $i)"
              break
            fi
            echo "⏳ Still waiting... ($i)"
            sleep 2
          done
          curl --fail http://localhost:8001/ready || \
            { echo "❌ Backend did not respond!"; docker compose logs backend; exit 1; }

      - name: Smoke — GET /ready → 200
        run: |
          S=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8001/ready)
          if [ "$S" = "200" ]; then
            echo "✅ /ready → 200"
          else
            echo "❌ /ready → $S"
            exit 1
          fi

      - name: Smoke — GET /health → 200
        run: |
          S=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8001/health)
          if [ "$S" = "200" ]; then
            echo "✅ /health → 200"
          else
            echo "❌ /health → $S"
            exit 1
          fi

      - name: Smoke — POST /auth/register → 201
        run: |
          S=$(curl -sf -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8001/auth/register \
            -H "Content-Type: application/json" \
            -d '{"email":"smoke@example.com","password":"SmokePass123!"}')
          if [ "$S" = "201" ]; then
            echo "✅ /auth/register → 201"
          else
            echo "❌ /auth/register → $S"
            exit 1
          fi

      - name: Smoke — POST /auth/login → JWT
        run: |
          R=$(curl -sf \
            -X POST http://localhost:8001/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"smoke@example.com","password":"SmokePass123!"}')
          echo "$R" | python3 -c \
            "import sys, json; d=json.load(sys.stdin); assert 'access_token' in d, 'no token'"
          echo "✅ /auth/login → JWT issued"

      - name: Smoke — GET /stats unauthenticated → 401
        run: |
          S=$(curl -o /dev/null -w "%{http_code}" http://localhost:8001/stats)
          if [ "$S" = "401" ]; then
            echo "✅ /stats unauth → 401"
          else
            echo "❌ /stats → $S"
            exit 1
          fi

      - name: Smoke — POST /game/start unauthenticated → 401
        run: |
          S=$(curl -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8001/game/start \
            -H "Content-Type: application/json" \
            -d '{"bet_amount":50}')
          if [ "$S" = "401" ]; then
            echo "✅ /game/start unauth → 401"
          else
            echo "❌ /game/start → $S"
            exit 1
          fi

      - name: Remove E2E environment
        if: always()
        run: |
          IMAGE_TAG=${{ needs.Push-to-ECR.outputs.tag }} \
            docker compose -f docker-compose.yml -f docker-compose.ecr.yml \
            down -v --remove-orphans

  # ───────────────────────────────────────────────────────────────────────────
  #  JOB 4 — Push to ECR  (main branch only)
  #  • Rebuild images from GHA cache and push to Amazon ECR
  #  • Auto-increment semantic version tag (patch bump)
  #  • Create and push a Git tag for traceability
  #  • Update image tags in the GitOps repo (blackjack-k8s/values.yaml)
  #
  #  Required secrets (Settings → Secrets and variables → Actions):
  #    AWS_ACCESS_KEY_ID       IAM key with ecr:GetAuthorizationToken + ecr:BatchCheckLayerAvailability + ecr:PutImage
  #    AWS_SECRET_ACCESS_KEY   Corresponding secret
  #
  #  Private ECR: 904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application
  #  Tags: backend-<version>, frontend-<version>  (immutable — no latest tag)
  #  After push: CI commits updated image tags back into infra/k8s/ manifests
  # ───────────────────────────────────────────────────────────────────────────
  Push-to-ECR:
    name: Push to ECR (${{ github.ref_name }})
    if: github.ref == 'refs/heads/main'
    needs: Package-application
    runs-on: ubuntu-latest
    permissions:
      contents: write # needed to create and push git version tags
    outputs:
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # full history required for git tag operations

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Login to Amazon ECR (private)
        run: |
          aws ecr get-login-password --region ap-south-1 | \
            docker login --username AWS --password-stdin \
            904233124111.dkr.ecr.ap-south-1.amazonaws.com

      - name: Compute next semantic version
        id: version
        run: |
          git fetch --tags
          latest=$(git tag -l '[0-9]*.[0-9]*.[0-9]*' | sort -V | tail -1)
          if [ -z "$latest" ]; then
            next="1.0.0"
          else
            IFS='.' read -r major minor patch <<< "$latest"
            next="${major}.${minor}.$((patch + 1))"
          fi
          echo "✅ New version: $next"
          echo "tag=$next" >> "$GITHUB_OUTPUT"

      - name: Rebuild and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          # Immutable tags only — no :latest (would fail on second push)
          tags: 904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application:backend-${{ steps.version.outputs.tag }}
          cache-from: type=gha,scope=backend

      - name: Rebuild and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: 904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application:frontend-${{ steps.version.outputs.tag }}
          cache-from: type=gha,scope=frontend

      - name: Create and push Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      - name: Update k8s manifests with new image tags
        run: |
          ECR="904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application"
          VER="${{ steps.version.outputs.tag }}"

          # Updates both the migrate init container and main container in backend.yaml
          sed -i "s|image: ${ECR}:backend-.*|image: ${ECR}:backend-${VER}|g" infra/k8s/backend.yaml
          sed -i "s|image: ${ECR}:frontend-.*|image: ${ECR}:frontend-${VER}|g" infra/k8s/frontend.yaml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add infra/k8s/backend.yaml infra/k8s/frontend.yaml
          git commit -m "ci: bump k8s image tags to ${VER} [skip ci]"
          git push origin main
