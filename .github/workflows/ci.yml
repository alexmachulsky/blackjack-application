name: CI

on:
  push:
    branches:
      - main
      - "feature/**"
  pull_request:
    branches:
      - main

# Default: all jobs get read-only access.
# Push-to-ECR overrides with contents: write for git tag creation.
permissions:
  contents: read

# Cancel in-flight runs on the same branch on every new push.
# Never cancel a run already deploying main.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  #  JOB 1 — Build & Test
  #  Lint, pytest, pip-audit, Trivy, /ready smoke
  # ─────────────────────────────────────────────────────────────────────────
  build:
    name: Build & Test (${{ github.ref_name }})
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements*.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
        working-directory: backend

      - name: Lint — ruff
        run: ruff check .
        working-directory: backend

      - name: Lint — black (format check)
        run: black --check .
        working-directory: backend

      - name: Run unit + integration tests
        env:
          DATABASE_URL: sqlite:///./test.db
          SECRET_KEY: ci-build-secret-key-minimum-32-characters-long
          ENVIRONMENT: testing
        run: pytest tests/ -v --tb=short
        working-directory: backend

      - name: Dependency vulnerability audit (Python)
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt --strict
        working-directory: backend

      - name: Filesystem vulnerability scan (Trivy)
        uses: aquasecurity/trivy-action@e368e328979b113139d6f9068e03accaed98a518 # v0.34.1
        with:
          scan-type: fs
          scan-ref: .
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          format: table

      - name: Start backend (readiness check)
        env:
          DATABASE_URL: sqlite:///./smoke.db
          SECRET_KEY: ci-build-secret-key-minimum-32-characters-long
          ENVIRONMENT: testing
        run: |
          nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > uvicorn.log 2>&1 &
          for i in {1..30}; do
            if curl -sf http://localhost:8000/ready > /dev/null; then
              echo "Backend is up (attempt $i)"
              break
            fi
            echo "Waiting... ($i)"
            sleep 1
          done
          curl --fail http://localhost:8000/ready || \
            { echo "Backend did not respond"; cat uvicorn.log; exit 1; }
        working-directory: backend

  # ─────────────────────────────────────────────────────────────────────────
  #  JOB 2 — Package
  #  Build backend + frontend Docker images and cache layers for reuse
  # ─────────────────────────────────────────────────────────────────────────
  package:
    name: Package (${{ github.ref_name }})
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: false
          tags: blackjack-backend:ci
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: Build frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: false
          tags: blackjack-frontend:ci
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

  # ─────────────────────────────────────────────────────────────────────────
  #  JOB 3 — Push to ECR  (main only)
  #  Versioned immutable tags pushed to private ECR, then k8s manifests updated
  #
  #  Required secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
  #  ECR: 904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application
  # ─────────────────────────────────────────────────────────────────────────
  push-to-ecr:
    name: Push to ECR (${{ github.ref_name }})
    needs: package
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    outputs:
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: arn:aws:iam::904233124111:role/github-actions-blackjack
          aws-region: ap-south-1

      - name: Login to Amazon ECR (private)
        run: |
          aws ecr get-login-password --region ap-south-1 | \
            docker login --username AWS --password-stdin \
            904233124111.dkr.ecr.ap-south-1.amazonaws.com

      - name: Compute next semantic version
        id: version
        run: |
          git fetch --tags
          latest=$(git tag -l '[0-9]*.[0-9]*.[0-9]*' | sort -V | tail -1)
          if [ -z "$latest" ]; then
            next="1.0.0"
          else
            IFS='.' read -r major minor patch <<< "$latest"
            next="${major}.${minor}.$((patch + 1))"
          fi
          echo "New version: $next"
          echo "tag=$next" >> "$GITHUB_OUTPUT"

      - name: Push backend image to ECR
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          platforms: linux/amd64
          provenance: false
          tags: 904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application:backend-${{ steps.version.outputs.tag }}
          build-args: BUILD_SHA=${{ github.sha }}
          cache-from: type=gha,scope=backend

      - name: Push frontend image to ECR
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          platforms: linux/amd64
          provenance: false
          tags: 904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application:frontend-${{ steps.version.outputs.tag }}
          build-args: BUILD_SHA=${{ github.sha }}
          cache-from: type=gha,scope=frontend

      - name: Create and push Git version tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      - name: Update k8s manifests with new image tags
        run: |
          ECR="904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application"
          VER="${{ steps.version.outputs.tag }}"
          sed -i "s|image: ${ECR}:backend-.*|image: ${ECR}:backend-${VER}|g" infra/k8s/backend.yaml
          sed -i "s|image: ${ECR}:frontend-.*|image: ${ECR}:frontend-${VER}|g" infra/k8s/frontend.yaml
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add infra/k8s/backend.yaml infra/k8s/frontend.yaml
          git commit -m "ci: bump k8s image tags to ${VER} [skip ci]"
          git push origin main

  # ─────────────────────────────────────────────────────────────────────────
  #  JOB 4 — E2E Smoke Tests  (main only)
  #  Pulls exact versioned image from ECR, runs 6 smoke tests, then tears down
  # ─────────────────────────────────────────────────────────────────────────
  e2e:
    name: E2E Smoke Tests (${{ github.ref_name }})
    needs: push-to-ecr
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create .env for stack
        run: |
          cat > .env << 'EOF'
          POSTGRES_USER=blackjack
          POSTGRES_PASSWORD=blackjack_ci_pw
          POSTGRES_DB=blackjack
          DATABASE_URL=postgresql://blackjack:blackjack_ci_pw@postgres:5432/blackjack
          SECRET_KEY=ci-e2e-secret-key-32-characters-minimum
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          ENVIRONMENT=testing
          LOG_LEVEL=WARNING
          EOF

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: arn:aws:iam::904233124111:role/github-actions-blackjack
          aws-region: ap-south-1

      - name: Login to Amazon ECR (private)
        run: |
          aws ecr get-login-password --region ap-south-1 | \
            docker login --username AWS --password-stdin \
            904233124111.dkr.ecr.ap-south-1.amazonaws.com

      - name: Pull backend image from ECR
        run: |
          docker pull 904233124111.dkr.ecr.ap-south-1.amazonaws.com/blackjack-application:backend-${{ needs.push-to-ecr.outputs.tag }}
          echo "Pulled backend-${{ needs.push-to-ecr.outputs.tag }} from ECR"

      - name: Start stack (postgres + ECR backend image)
        run: |
          IMAGE_TAG=${{ needs.push-to-ecr.outputs.tag }} \
            docker compose -f docker-compose.yml -f docker-compose.ecr.yml \
            up --no-build -d postgres backend

      - name: Wait for backend /ready
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:8001/ready > /dev/null; then
              echo "Backend ready (attempt $i)"
              break
            fi
            echo "Waiting... ($i)"
            sleep 2
          done
          curl --fail http://localhost:8001/ready || \
            { echo "Backend did not start"; docker compose logs backend; exit 1; }

      - name: Smoke — GET /ready → 200
        run: |
          S=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8001/ready)
          [ "$S" = "200" ] && echo "OK /ready → 200" || { echo "FAIL /ready → $S"; exit 1; }

      - name: Smoke — GET /health → 200
        run: |
          S=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8001/health)
          [ "$S" = "200" ] && echo "OK /health → 200" || { echo "FAIL /health → $S"; exit 1; }

      - name: Smoke — POST /auth/register → 201
        run: |
          S=$(curl -sf -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8001/auth/register \
            -H "Content-Type: application/json" \
            -d '{"email":"smoke@example.com","password":"SmokePass123!"}')
          [ "$S" = "201" ] && echo "OK /auth/register → 201" || { echo "FAIL /auth/register → $S"; exit 1; }

      - name: Smoke — POST /auth/login → JWT
        run: |
          R=$(curl -sf \
            -X POST http://localhost:8001/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"smoke@example.com","password":"SmokePass123!"}')
          echo "$R" | python3 -c \
            "import sys, json; d=json.load(sys.stdin); assert 'access_token' in d, 'no token'"
          echo "OK /auth/login → JWT issued"

      - name: Smoke — GET /stats unauthenticated → 401
        run: |
          S=$(curl -o /dev/null -w "%{http_code}" http://localhost:8001/stats)
          [ "$S" = "401" ] && echo "OK /stats unauth → 401" || { echo "FAIL /stats → $S"; exit 1; }

      - name: Smoke — POST /game/start unauthenticated → 401
        run: |
          S=$(curl -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8001/game/start \
            -H "Content-Type: application/json" \
            -d '{"bet_amount":50}')
          [ "$S" = "401" ] && echo "OK /game/start unauth → 401" || { echo "FAIL /game/start → $S"; exit 1; }

      - name: Teardown
        if: always()
        run: |
          IMAGE_TAG=${{ needs.push-to-ecr.outputs.tag }} \
            docker compose -f docker-compose.yml -f docker-compose.ecr.yml \
            down -v --remove-orphans
