name: CI

on:
    push:
        branches: [main, develop, "feature/**", "fix/**"]
    pull_request:
        branches: [main, develop]

# Cancel in-progress runs for the same branch/PR to save CI minutes
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # ──────────────────────────────────────────────────────────────
    # Job 1: Lint backend (ruff) + frontend (eslint)
    # ──────────────────────────────────────────────────────────────
    lint:
        name: Lint
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: pip

            - name: Install backend lint deps
              run: |
                  pip install ruff black
              working-directory: backend

            - name: Ruff lint
              run: ruff check .
              working-directory: backend

            - name: Black format check
              run: black --check .
              working-directory: backend

            - name: Set up Node 18
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: npm
                  cache-dependency-path: frontend/package-lock.json

            - name: Install frontend deps
              run: npm ci
              working-directory: frontend

            # ESLint is not yet installed — skip if not available; add eslint to package.json to enable
            - name: Frontend build check
              run: npm run build
              working-directory: frontend

    # ──────────────────────────────────────────────────────────────
    # Job 2: Backend unit tests (no Docker, SQLite in-process)
    # ──────────────────────────────────────────────────────────────
    test-backend:
        name: Backend Tests
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: pip

            - name: Install production + dev deps
              run: |
                  pip install -r requirements.txt -r requirements-dev.txt
              working-directory: backend

            - name: Run pytest with coverage
              env:
                  # Provide required settings so config.py validation passes in CI
                  DATABASE_URL: sqlite:///./test.db
                  SECRET_KEY: ci-test-secret-key-minimum-32-characters-long
                  ENVIRONMENT: testing
              run: |
                  pytest tests/ \
                    --cov=app \
                    --cov-report=xml:coverage.xml \
                    --cov-report=term-missing
              working-directory: backend

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: backend-coverage
                  path: backend/coverage.xml

    # ──────────────────────────────────────────────────────────────
    # Job 3: Docker build verification (no push)
    # Ensures images build cleanly on every PR
    # ──────────────────────────────────────────────────────────────
    docker-build:
        name: Docker Build
        runs-on: ubuntu-latest
        needs: [lint, test-backend]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build backend image
              uses: docker/build-push-action@v5
              with:
                  context: ./backend
                  push: false
                  tags: blackjack-backend:ci
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build frontend image (production stage)
              uses: docker/build-push-action@v5
              with:
                  context: ./frontend
                  target: production
                  push: false
                  tags: blackjack-frontend:ci
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
