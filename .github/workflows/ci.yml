name: CI

# ──────────────────────────────────────────────────────────────────────────────
# 7-Stage CI Pipeline
#
# Stage 1 — Trigger       : push / PR event (this block)
# Stage 2 — Build         : Docker images compiled, GHA layer cache written
# Stage 3 — Unit Tests    : fast, isolated  — pytest -m unit
# Stage 4 — Static Analysis : ruff + black + bandit  (after Stage 3)
# Stage 5 — Integration   : HTTP routes + DB — pytest -m integration
# Stage 6 — Package       : Trivy CVE scan + push to GHCR (main/develop only)
# Stage 7 — Deploy/Notify : staging deploy + GitHub Step Summary  (main/develop)
#
# Each stage runs ONLY if the previous stage succeeded (strict linear pipeline).
# ──────────────────────────────────────────────────────────────────────────────

# ── Stage 1: Trigger ─────────────────────────────────────────────────────────
on:
    push:
        branches: [main, develop, "feature/**", "fix/**"]
    pull_request:
        branches: [main, develop]

permissions:
    contents: read   # principle of least privilege — jobs escalate only what they need

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
    REGISTRY: ghcr.io
    BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/blackjack-backend
    FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/blackjack-frontend
    PYTHON_VERSION: "3.11"
    NODE_VERSION: "20"

jobs:

    # ── Stage 2: Build ────────────────────────────────────────────────────────
    # Validate both Dockerfiles compile cleanly and write GHA layer cache.
    # push: false, load: false — validates without storing the image locally.
    # Stage 6 (package) rebuilds from this cache in seconds.
    # ─────────────────────────────────────────────────────────────────────────
    build:
        name: "Stage 2 — Build"
        runs-on: ubuntu-22.04
        timeout-minutes: 15

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build backend image (cache only)
              uses: docker/build-push-action@v5
              with:
                  context: ./backend
                  push: false
                  load: false
                  tags: ${{ env.BACKEND_IMAGE }}:build-check
                  cache-from: type=gha,scope=backend
                  cache-to: type=gha,mode=max,scope=backend

            - name: Build frontend image (cache only)
              uses: docker/build-push-action@v5
              with:
                  context: ./frontend
                  target: production
                  push: false
                  load: false
                  tags: ${{ env.FRONTEND_IMAGE }}:build-check
                  cache-from: type=gha,scope=frontend
                  cache-to: type=gha,mode=max,scope=frontend

    # ── Stage 3: Unit Tests ───────────────────────────────────────────────────
    # Fast, isolated — no DB, no HTTP.  pytest -m unit
    # Runs after Build (if Dockerfile breaks, no point testing).
    # Runs in parallel with Stage 4 (Static Analysis).
    # ─────────────────────────────────────────────────────────────────────────
    unit-tests:
        name: "Stage 3 — Unit Tests"
        runs-on: ubuntu-22.04
        timeout-minutes: 10
        needs: build

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: pip

            - name: Upgrade pip
              run: pip install --upgrade pip

            - name: Install deps
              run: pip install -r requirements.txt -r requirements-dev.txt
              working-directory: backend

            - name: Run unit tests
              env:
                  DATABASE_URL: sqlite:///./test.db
                  SECRET_KEY: ci-test-secret-key-minimum-32-characters-long
                  ENVIRONMENT: testing
                  PYTHONDONTWRITEBYTECODE: "1"
                  PYTHONUNBUFFERED: "1"
              run: |
                  pytest tests/ -m unit \
                    --cov=app \
                    --cov-report=xml:coverage-unit.xml \
                    --cov-report=term-missing \
                    -v
              working-directory: backend

            - name: Upload unit test coverage
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-unit
                  path: backend/coverage-unit.xml
                  retention-days: 30

    # ── Stage 4: Static Analysis ──────────────────────────────────────────────
    # Code quality gate — ruff (lint) + black (format) + bandit (SAST).
    # Runs only after Stage 3 (Unit Tests) passes.
    # ─────────────────────────────────────────────────────────────────────────
    static-analysis:
        name: "Stage 4 — Static Analysis"
        runs-on: ubuntu-22.04
        timeout-minutes: 10
        needs: unit-tests

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: pip

            - name: Upgrade pip
              run: pip install --upgrade pip

            - name: Install analysis tools
              run: pip install "ruff==0.2.1" "black==24.1.1" "bandit[toml]==1.7.7"

            # ── Ruff ──────────────────────────────────────────────────────────
            - name: Ruff lint
              run: ruff check .
              working-directory: backend

            # ── Black ─────────────────────────────────────────────────────────
            - name: Black format check
              run: black --check .
              working-directory: backend

            # ── Bandit ────────────────────────────────────────────────────────
            # Text step: human-readable log — exits non-zero on MEDIUM/HIGH finds
            - name: Bandit SAST
              run: bandit -r app/ -ll -x tests/
              working-directory: backend

            # JSON artifact — always saved so findings are reviewable even on pass
            - name: Save Bandit JSON report
              if: always()
              run: bandit -r app/ -ll -x tests/ --exit-zero --format json --output bandit-report.json
              working-directory: backend

            - name: Upload Bandit report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: bandit-report
                  path: backend/bandit-report.json
                  retention-days: 30

            # ── Frontend build lint ───────────────────────────────────────────
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm
                  cache-dependency-path: frontend/package-lock.json

            - name: Install frontend deps
              run: npm ci
              working-directory: frontend

            - name: Frontend build check
              run: npm run build
              working-directory: frontend

    # ── Stage 5: Integration Tests ────────────────────────────────────────────
    # Validate HTTP contracts, auth flows, and game routes via TestClient+SQLite.
    # Runs only after Stage 4 (Static Analysis) passes.
    # ─────────────────────────────────────────────────────────────────────────
    integration-tests:
        name: "Stage 5 — Integration Tests"
        runs-on: ubuntu-22.04
        timeout-minutes: 15
        needs: static-analysis

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: pip

            - name: Upgrade pip
              run: pip install --upgrade pip

            - name: Install deps
              run: pip install -r requirements.txt -r requirements-dev.txt
              working-directory: backend

            - name: Run integration tests
              env:
                  DATABASE_URL: sqlite:///./test.db
                  SECRET_KEY: ci-test-secret-key-minimum-32-characters-long
                  ENVIRONMENT: testing
                  PYTHONDONTWRITEBYTECODE: "1"
                  PYTHONUNBUFFERED: "1"
              run: |
                  pytest tests/ -m integration \
                    --cov=app \
                    --cov-report=xml:coverage-integration.xml \
                    --cov-report=term-missing \
                    -v
              working-directory: backend

            - name: Upload integration test coverage
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-integration
                  path: backend/coverage-integration.xml
                  retention-days: 30

    # ── Stage 6: Package (Artifact) ───────────────────────────────────────────
    # Build images from GHA cache (fast), run Trivy CVE scan, then push to GHCR.
    # Push is conditional: only on main and develop branches.
    #   Tags: sha-<short_commit>  ← immutable reference
    #         latest              ← convenience pointer
    #
    # Requires security-events: write for SARIF upload to GitHub Security tab.
    # ─────────────────────────────────────────────────────────────────────────
    package:
        name: "Stage 6 — Package"
        runs-on: ubuntu-22.04
        timeout-minutes: 20
        needs: integration-tests

        permissions:
            contents: read
            packages: write          # push to GHCR
            security-events: write   # upload Trivy SARIF to GitHub Security tab

        outputs:
            image_tag: ${{ steps.meta.outputs.tag }}

        steps:
            - uses: actions/checkout@v4

            - name: Compute image tag
              id: meta
              run: echo "tag=sha-$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GHCR
              # Login only when we will actually push (saves auth round-trip on PRs)
              if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            # ── Backend ───────────────────────────────────────────────────────
            # load: true and push: true are mutually exclusive in buildx.
            # Pattern: build+load for Trivy, then `docker push` after scan passes.
            - name: Build backend image (load for Trivy scan)
              uses: docker/build-push-action@v5
              with:
                  context: ./backend
                  push: false
                  load: true
                  tags: |
                      ${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.tag }}
                      ${{ env.BACKEND_IMAGE }}:latest
                  labels: |
                      org.opencontainers.image.revision=${{ github.sha }}
                      org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
                  cache-from: type=gha,scope=backend
                  cache-to: type=gha,mode=max,scope=backend

            - name: Trivy scan — backend (blocking)
              uses: aquasecurity/trivy-action@0.24.0
              with:
                  image-ref: ${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.tag }}
                  format: table
                  exit-code: "1"
                  severity: CRITICAL
                  ignore-unfixed: true

            - name: Trivy scan — backend (SARIF)
              uses: aquasecurity/trivy-action@0.24.0
              if: always()
              with:
                  image-ref: ${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.tag }}
                  format: sarif
                  output: trivy-backend.sarif
                  ignore-unfixed: true

            - name: Upload backend SARIF
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: trivy-backend.sarif
                  category: trivy-backend

            - name: Push backend image to GHCR
              if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
              run: |
                  docker push ${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.tag }}
                  docker push ${{ env.BACKEND_IMAGE }}:latest

            # ── Frontend ──────────────────────────────────────────────────────
            - name: Build frontend image (load for Trivy scan)
              uses: docker/build-push-action@v5
              with:
                  context: ./frontend
                  target: production
                  push: false
                  load: true
                  tags: |
                      ${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.tag }}
                      ${{ env.FRONTEND_IMAGE }}:latest
                  labels: |
                      org.opencontainers.image.revision=${{ github.sha }}
                      org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
                  cache-from: type=gha,scope=frontend
                  cache-to: type=gha,mode=max,scope=frontend

            - name: Trivy scan — frontend (blocking)
              uses: aquasecurity/trivy-action@0.24.0
              with:
                  image-ref: ${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.tag }}
                  format: table
                  exit-code: "1"
                  severity: CRITICAL
                  ignore-unfixed: true

            - name: Trivy scan — frontend (SARIF)
              uses: aquasecurity/trivy-action@0.24.0
              if: always()
              with:
                  image-ref: ${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.tag }}
                  format: sarif
                  output: trivy-frontend.sarif
                  ignore-unfixed: true

            - name: Upload frontend SARIF
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: trivy-frontend.sarif
                  category: trivy-frontend

            - name: Push frontend image to GHCR
              if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
              run: |
                  docker push ${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.tag }}
                  docker push ${{ env.FRONTEND_IMAGE }}:latest

    # ── Stage 7: Deploy to Staging + Notify ──────────────────────────────────
    # Automatically deploy to the staging environment after all gates pass.
    # Only runs on main and develop — never on feature/fix branches.
    #
    # Environment secrets (GitHub repo → Settings → Environments → staging):
    #   DEPLOY_HOST      — SSH hostname / IP of staging server
    #   DEPLOY_USER      — SSH username
    #   DEPLOY_SSH_KEY   — Private key (PEM, no passphrase)
    #   GHCR_READ_TOKEN  — GitHub PAT with read:packages scope
    # ─────────────────────────────────────────────────────────────────────────
    deploy-staging:
        name: "Stage 7 — Deploy to Staging"
        runs-on: ubuntu-22.04
        timeout-minutes: 15
        needs: package
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

        environment:
            name: staging
            url: ${{ vars.STAGING_URL }}

        steps:
            - uses: actions/checkout@v4

            - name: Deploy to staging via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}    # ec2-user on Amazon Linux 2023
                  key: ${{ secrets.DEPLOY_SSH_KEY }}
                  script: |
                      set -e
                      cd /opt/blackjack-application
                      git pull origin ${{ github.ref_name }}

                      BACKEND_IMAGE=${{ env.BACKEND_IMAGE }}
                      FRONTEND_IMAGE=${{ env.FRONTEND_IMAGE }}
                      IMAGE_TAG=${{ needs.package.outputs.image_tag }}

                      # Pull the specific immutable SHA-tagged images
                      # GHCR packages on this public repo are publicly pullable
                      docker pull "$${BACKEND_IMAGE}:$${IMAGE_TAG}"
                      docker pull "$${FRONTEND_IMAGE}:$${IMAGE_TAG}"

                      # Retag as :latest so docker-compose.yml references resolve
                      docker tag "$${BACKEND_IMAGE}:$${IMAGE_TAG}" blackjack-application_backend:latest
                      docker tag "$${FRONTEND_IMAGE}:$${IMAGE_TAG}" blackjack-application_frontend:latest

                      # Start with the AWS overlay:
                      #   - removes backend→postgres depends_on
                      #   - prevents the local postgres container from starting (RDS is used)
                      docker compose \
                        -f docker-compose.yml \
                        -f docker-compose.prod.yml \
                        -f infra/docker-compose.aws.yml \
                        up -d --remove-orphans backend frontend

                      docker image prune -f

                      # Health check via nginx (port 80) — nginx proxies /health to backend
                      for i in $(seq 1 6); do
                        curl -sf http://localhost/health && break
                        echo "Health check attempt $i/6 failed — retrying in 5s"
                        sleep 5
                      done

            # ── Notify via GitHub Step Summary ────────────────────────────────
            # Zero-dependency: visible in the Actions run UI for every deploy.
            # Replace / extend with Slack/Teams webhook when ready.
            - name: Notify — write deploy summary
              if: always()
              run: |
                  STATUS="${{ job.status }}"
                  TAG="${{ needs.package.outputs.image_tag }}"
                  BRANCH="${{ github.ref_name }}"
                  ACTOR="${{ github.actor }}"
                  SHA="${{ github.sha }}"

                  if [ "$STATUS" = "success" ]; then
                    ICON="✅"
                    HEADLINE="Staging deploy succeeded"
                  else
                    ICON="❌"
                    HEADLINE="Staging deploy FAILED"
                  fi

                  cat >> "$GITHUB_STEP_SUMMARY" <<EOF
                  ## $ICON $HEADLINE

                  | Field       | Value |
                  |-------------|-------|
                  | Branch      | \`$BRANCH\` |
                  | Commit      | \`${SHA::7}\` |
                  | Image tag   | \`$TAG\` |
                  | Triggered by | $ACTOR |
                  | Status      | $STATUS |
                  EOF
